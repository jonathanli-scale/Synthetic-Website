# Event Logging System

This document describes the event logging system implemented for the travel booking website. The system captures user interactions and database operations for analytics and debugging purposes.

## Overview

The logging system consists of:
- **Frontend Logger**: Captures user interactions (clicks, hovers, navigation, etc.)
- **Backend Logger**: Captures database operations and API calls
- **Database Storage**: Stores all events in the `event_logs` table
- **Logging Wrapper**: Reusable component for adding logging to UI elements

## Event Types

### Frontend Events (sent from browser)

#### CLICK
```json
{
  "type": "CLICK",
  "text": "User clicked on hotel search button",
  "page_url": "http://localhost:3003/",
  "element_identifier": "[data-testid='hotel-search-btn']",
  "coordinates": {"x": 150, "y": 45}
}
```

#### SCROLL
```json
{
  "type": "SCROLL",
  "text": "User scrolled down on search results page",
  "page_url": "http://localhost:3003/search",
  "scroll_x": 0,
  "scroll_y": 250
}
```

#### HOVER
```json
{
  "type": "HOVER",
  "text": "User hovered over luxury hotel card",
  "page_url": "http://localhost:3003/search",
  "element_identifier": "[data-hotel-id='1']"
}
```

#### KEY_PRESS
```json
{
  "type": "KEY_PRESS",
  "text": "User pressed Enter in destination search field",
  "page_url": "http://localhost:3003/",
  "element_identifier": "#destination-input",
  "key": "Enter"
}
```

#### NAVIGATION
```json
{
  "type": "GO_TO_URL",
  "text": "User navigated to hotel booking page",
  "page_url": "http://localhost:3003/search",
  "target_url": "http://localhost:3003/hotels/1"
}
```

#### STORAGE
```json
{
  "type": "SET_STORAGE",
  "text": "User preferences saved to localStorage",
  "page_url": "http://localhost:3003/dashboard",
  "storage_type": "local",
  "key": "user_preferences",
  "value": "{\"currency\":\"USD\",\"language\":\"en\"}"
}
```

#### CUSTOM
```json
{
  "type": "CUSTOM",
  "text": "User searched for hotels in Paris for 2 guests",
  "custom_action": "hotel_search",
  "data": {
    "destination": "Paris",
    "guests": 2,
    "checkIn": "2024-03-15",
    "checkOut": "2024-03-17"
  }
}
```

### Backend Events (generated by server)

#### DB_UPDATE
```json
{
  "type": "DB_UPDATE",
  "text": "Created new booking TRV-ABC123 for user john@example.com",
  "table_name": "bookings",
  "update_type": "insert",
  "values": {
    "booking_reference": "TRV-ABC123",
    "user_id": 1,
    "total_price": 299.99
  }
}
```

## Frontend Usage

### Basic Logger Usage

```typescript
import { useEventLogger } from '../../utils/logger';

function MyComponent() {
  const logger = useEventLogger();

  const handleButtonClick = (event: React.MouseEvent) => {
    // Log the click with coordinates
    const rect = event.currentTarget.getBoundingClientRect();
    logger.logClick(
      'User clicked the search button',
      '#search-button',
      { 
        x: event.clientX - rect.left, 
        y: event.clientY - rect.top 
      }
    );
  };

  return <button onClick={handleButtonClick}>Search</button>;
}
```

### Using LoggingWrapper

```typescript
import { LoggingWrapper } from '../ui/LoggingWrapper';
import { Button } from '../ui/Button';

function MyComponent() {
  return (
    <LoggingWrapper
      logClick={true}
      logHover={true}
      clickDescription="User clicked the primary CTA button"
      hoverDescription="User hovered over the primary CTA button"
      elementId="primary-cta"
      customData={{ section: 'hero', campaign: 'summer-2024' }}
    >
      <Button variant="primary">Book Now</Button>
    </LoggingWrapper>
  );
}
```

### Advanced Custom Logging

```typescript
import { useEventLogger } from '../../utils/logger';

function SearchForm() {
  const logger = useEventLogger();

  const handleSearchSubmit = (searchData: any) => {
    // Log the search action
    logger.logCustom(
      `User searched for ${searchData.type}: ${searchData.destination}`,
      'search_performed',
      {
        searchType: searchData.type,
        destination: searchData.destination,
        dates: {
          checkIn: searchData.checkIn,
          checkOut: searchData.checkOut
        },
        filters: searchData.filters
      }
    );

    // Log navigation
    logger.logNavigation(
      'Redirecting to search results',
      'GO_TO_URL',
      `/search?${new URLSearchParams(searchData).toString()}`
    );
  };

  return (
    // ... form components
  );
}
```

## Backend Usage

### Database Operation Logging

```python
from app.api.v1.endpoints.logs import log_db_update_async

async def create_booking(booking_data: BookingCreate, user: User, db: AsyncSession):
    # Create the booking
    new_booking = Booking(**booking_data.dict())
    db.add(new_booking)
    await db.commit()
    
    # Log the database operation
    await log_db_update_async(
        db=db,
        text=f"Created booking {new_booking.reference} for user {user.email}",
        table_name="bookings",
        update_type="insert",
        values={
            "booking_reference": new_booking.reference,
            "user_id": user.id,
            "total_price": new_booking.total_price,
            "booking_type": new_booking.booking_type
        },
        user_id=str(user.id)
    )
    
    return new_booking
```

### Custom Backend Events

```python
from app.api.v1.endpoints.logs import EventLog
from datetime import datetime

async def log_payment_processed(db: AsyncSession, booking_id: str, amount: float, user_id: str):
    event_log = EventLog(
        event_type='PAYMENT_PROCESSED',
        description=f"Payment of ${amount} processed for booking {booking_id}",
        user_id=user_id,
        timestamp=datetime.utcnow(),
        metadata={
            'booking_id': booking_id,
            'amount': amount,
            'payment_method': 'credit_card',
            'status': 'completed'
        },
        source='backend'
    )
    
    db.add(event_log)
    await db.commit()
```

## Database Schema

```sql
CREATE TABLE event_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_type VARCHAR NOT NULL,
    description TEXT NOT NULL,
    user_id VARCHAR,
    session_id VARCHAR,
    timestamp DATETIME NOT NULL,
    metadata JSON,
    source VARCHAR NOT NULL DEFAULT 'frontend',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for better query performance
CREATE INDEX idx_event_logs_event_type ON event_logs(event_type);
CREATE INDEX idx_event_logs_user_id ON event_logs(user_id);
CREATE INDEX idx_event_logs_session_id ON event_logs(session_id);
CREATE INDEX idx_event_logs_timestamp ON event_logs(timestamp);
```

## API Endpoints

### Log Frontend Event
```
POST /api/v1/logs/events
Content-Type: application/json

{
  "type": "CLICK",
  "text": "User clicked search button",
  "timestamp": "2024-03-15T10:30:00Z",
  "user_id": "123",
  "session_id": "session_456",
  "page_url": "http://localhost:3003/",
  "element_identifier": "#search-btn",
  "coordinates": {"x": 100, "y": 50}
}
```

### Retrieve Events
```
GET /api/v1/logs/events?limit=50&user_id=123&event_type=CLICK

Response:
{
  "events": [...],
  "total": 150
}
```

## Best Practices

### 1. Descriptive Text Fields
Always provide clear, descriptive text that includes relevant context:

✅ **Good**: `"User searched for hotels in Paris from 2024-03-15 to 2024-03-17 for 2 guests"`

❌ **Bad**: `"Search performed"`

### 2. Include Relevant Data
Add context that helps understand user behavior:

```typescript
logger.logCustom(
  `User filtered hotels by price range $${minPrice}-$${maxPrice}`,
  'filter_applied',
  {
    filterType: 'price',
    minPrice: minPrice,
    maxPrice: maxPrice,
    resultCount: filteredResults.length,
    originalCount: allResults.length
  }
);
```

### 3. Use Consistent Element Identifiers
Prefer `data-testid` attributes or CSS selectors:

```typescript
// Good
logger.logClick("User clicked login button", "[data-testid='login-btn']", coords);

// Also good
logger.logClick("User clicked login button", "#header-login-button", coords);
```

### 4. Error Handling
The logger includes built-in error handling and retry logic:

```typescript
// Failed events are automatically stored in localStorage and retried
logger.retryFailedEvents(); // Call this when connection is restored
```

## Analytics Queries

### Common User Flows
```sql
-- Find user journey from search to booking
SELECT 
    event_type,
    description,
    timestamp,
    metadata->>'page_url' as page_url
FROM event_logs 
WHERE user_id = '123' 
    AND timestamp BETWEEN '2024-03-15' AND '2024-03-16'
ORDER BY timestamp;
```

### Popular Search Terms
```sql  
-- Most searched destinations
SELECT 
    metadata->>'destination' as destination,
    COUNT(*) as search_count
FROM event_logs 
WHERE event_type = 'CUSTOM' 
    AND metadata->>'custom_action' = 'hotel_search'
    AND timestamp >= '2024-03-01'
GROUP BY metadata->>'destination'
ORDER BY search_count DESC
LIMIT 10;
```

### User Engagement Metrics
```sql
-- Click-through rates by page
SELECT 
    metadata->>'page_url' as page,
    COUNT(CASE WHEN event_type = 'CLICK' THEN 1 END) as clicks,
    COUNT(CASE WHEN event_type = 'GO_TO_URL' THEN 1 END) as navigations,
    ROUND(COUNT(CASE WHEN event_type = 'GO_TO_URL' THEN 1 END) * 100.0 / 
          COUNT(CASE WHEN event_type = 'CLICK' THEN 1 END), 2) as ctr
FROM event_logs 
WHERE timestamp >= '2024-03-01'
GROUP BY metadata->>'page_url';
```

## Troubleshooting

### Events Not Appearing
1. Check browser console for errors
2. Verify backend is running and `/api/v1/logs/events` endpoint is accessible
3. Check localStorage for `failed_log_events` (indicates connection issues)
4. Verify database table exists and has proper permissions

### Performance Considerations
- Events are sent asynchronously and won't block UI
- Failed events are queued locally and retried
- Database logging uses a separate transaction to avoid affecting main operations
- Consider rate limiting on high-frequency events (like scroll)

### Privacy Considerations
- User IDs are optional and can be omitted for anonymous tracking
- Sensitive data should not be included in event logs
- Consider GDPR compliance for EU users
- Events can be filtered by user preference settings 